name: Cleanup R2 Releases

on:
  workflow_dispatch:
    inputs:
      retain_count:
        description: 'Number of versions to retain per channel'
        required: false
        default: '10'
      dry_run:
        description: 'Dry run (list but do not delete)'
        required: false
        type: boolean
        default: false

jobs:
  cleanup:
    name: Prune old R2 releases
    runs-on: ubuntu-latest

    steps:
    - name: Clean up old releases (retain ${{ inputs.retain_count }} most recent)
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        R2_BUCKET: ${{ vars.R2_BUCKET_NAME || 'helixscreen-releases' }}
        RETAIN_COUNT: ${{ inputs.retain_count }}
        DRY_RUN: ${{ inputs.dry_run }}
      run: |
        semver_sort() {
          sort -t. -k1,1n -k2,2n -k3,3n
        }

        for CHANNEL in stable beta dev; do
          echo "=== Checking ${CHANNEL} channel ==="

          # List all objects in channel
          LISTING=$(aws s3 ls "s3://${R2_BUCKET}/${CHANNEL}/" \
            --endpoint-url "$R2_ENDPOINT" 2>/dev/null || true)

          if [ -z "$LISTING" ]; then
            echo "No objects found in ${CHANNEL}, skipping"
            continue
          fi

          # Extract unique versions — anchor at .tar.gz to avoid matching extension
          VERSIONS=$(echo "$LISTING" \
            | grep -oP 'helixscreen-\w+-v\K[0-9]+\.[0-9]+\.[0-9]+(?:-[a-zA-Z0-9.]+)?(?=\.tar\.gz)' \
            | sort -u \
            | semver_sort)

          VERSION_COUNT=$(echo "$VERSIONS" | grep -c . || true)
          echo "Found ${VERSION_COUNT} versions in ${CHANNEL}:"
          echo "$VERSIONS" | sed 's/^/  /'

          if [ "$VERSION_COUNT" -le "$RETAIN_COUNT" ]; then
            echo "Within retention limit (${RETAIN_COUNT}), nothing to prune"
            continue
          fi

          DELETE_VERSIONS=$(echo "$VERSIONS" | head -n -${RETAIN_COUNT})
          KEEP_VERSIONS=$(echo "$VERSIONS" | tail -n ${RETAIN_COUNT})
          DELETE_COUNT=$(echo "$DELETE_VERSIONS" | grep -c . || true)

          echo ""
          echo "Keeping ${RETAIN_COUNT} most recent:"
          echo "$KEEP_VERSIONS" | sed 's/^/  ✓ /'
          echo "Pruning ${DELETE_COUNT} old versions:"
          echo "$DELETE_VERSIONS" | sed 's/^/  ✗ /'

          for VERSION in $DELETE_VERSIONS; do
            aws s3 ls "s3://${R2_BUCKET}/${CHANNEL}/" \
              --endpoint-url "$R2_ENDPOINT" \
              | awk '{print $4}' \
              | grep -- "-v${VERSION}\." \
              | while read -r filename; do
                if [ "$DRY_RUN" = "true" ]; then
                  echo "  [DRY RUN] Would delete ${CHANNEL}/${filename}"
                else
                  echo "  Deleting ${CHANNEL}/${filename}"
                  aws s3 rm "s3://${R2_BUCKET}/${CHANNEL}/${filename}" \
                    --endpoint-url "$R2_ENDPOINT"
                fi
              done
          done

          echo "=== ${CHANNEL} complete ==="
          echo ""
        done

        # Prune old symbol maps
        echo "=== Checking symbol maps ==="
        SYM_VERSIONS=$(aws s3 ls "s3://${R2_BUCKET}/symbols/" \
          --endpoint-url "$R2_ENDPOINT" 2>/dev/null \
          | grep -oP 'PRE v\K[0-9]+\.[0-9]+\.[0-9]+(?:-[a-zA-Z0-9.]+)?' \
          | sort -u \
          | semver_sort)

        SYM_COUNT=$(echo "$SYM_VERSIONS" | grep -c . || true)
        echo "Found ${SYM_COUNT} symbol versions"

        if [ "$SYM_COUNT" -gt "$RETAIN_COUNT" ]; then
          DELETE_SYM_VERSIONS=$(echo "$SYM_VERSIONS" | head -n -${RETAIN_COUNT})
          DELETE_SYM_COUNT=$(echo "$DELETE_SYM_VERSIONS" | grep -c . || true)

          echo "Pruning ${DELETE_SYM_COUNT} old symbol versions:"
          echo "$DELETE_SYM_VERSIONS" | sed 's/^/  ✗ v/'

          for VERSION in $DELETE_SYM_VERSIONS; do
            if [ "$DRY_RUN" = "true" ]; then
              echo "  [DRY RUN] Would delete symbols/v${VERSION}/"
            else
              echo "  Deleting symbols/v${VERSION}/"
              aws s3 rm "s3://${R2_BUCKET}/symbols/v${VERSION}/" \
                --endpoint-url "$R2_ENDPOINT" \
                --recursive
            fi
          done
        else
          echo "Within retention limit, nothing to prune"
        fi
        echo "=== Symbol cleanup complete ==="
