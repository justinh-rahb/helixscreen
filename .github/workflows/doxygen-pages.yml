name: Generate and Deploy Doxygen Documentation

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v0.1.0, v1.0.0)

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate git metadata

      - name: Install Doxygen and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
          doxygen --version

      - name: Generate Doxygen documentation
        run: |
          echo "Generating documentation with Doxygen..."
          doxygen Doxyfile

          if [ ! -d "build/docs/html" ]; then
            echo "âŒ ERROR: Doxygen failed to generate HTML output"
            exit 1
          fi

          echo "âœ… Documentation generated successfully"
          echo "ðŸ“Š Generated files:"
          du -sh build/docs/html

      - name: Prepare docs directory
        run: |
          # Create docs/api if it doesn't exist
          mkdir -p docs/api

          # Remove old generated content (keep .gitkeep and README.md)
          find docs/api -mindepth 1 ! -name '.gitkeep' ! -name 'README.md' -delete

          # Copy new generated docs
          cp -r build/docs/html/* docs/api/

          echo "âœ… Documentation prepared in docs/api/"
          ls -lah docs/api/ | head -20

      - name: Commit documentation to main branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to main branch
          git fetch origin main
          git checkout main

          # Copy docs/api changes
          git add docs/api/

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No documentation changes to commit"
            exit 0
          fi

          git commit -m "docs: update API documentation for ${GITHUB_REF_NAME}

Generated from tag: ${GITHUB_REF_NAME}
Commit: ${GITHUB_SHA}

Auto-generated by doxygen-pages workflow"

          git push origin main

          echo "âœ… Documentation committed to main branch"

      - name: Summary
        run: |
          echo "## ðŸ“š Doxygen Documentation Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation location:** \`docs/api/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Pages will deploy automatically from the \`docs/\` folder." >> $GITHUB_STEP_SUMMARY
