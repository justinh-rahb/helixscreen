<?xml version="1.0"?>
<!-- Copyright (C) 2025-2026 356C LLC -->
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- PID Tuning Calibration Panel -->
<!-- Interactive calibration using PID_CALIBRATE command for extruder or bed -->
<component>
  <styles>
    <style name="pid_heater_selected" bg_color="#tertiary" bg_opa="255"/>
    <style name="pid_heater_unselected" bg_color="#elevated_bg" bg_opa="255"/>
  </styles>
  <view name="calibration_pid_panel"
        extends="lv_obj" width="#overlay_panel_width" height="100%" align="right_mid" style_bg_opa="255"
        style_bg_color="#card_bg" style_pad_all="0" style_border_width="0" scrollable="false" flex_flow="column">
    <!-- Header Bar -->
    <header_bar name="overlay_header" title="Automatic PID Calibration" title_tag="Automatic PID Calibration"
                hide_action_button="false" action_button_text="Start" action_button_callback="on_pid_start"
                action_button_disabled_subject="pid_cal_not_idle"/>
    <!-- Content Area -->
    <lv_obj name="overlay_content"
            width="100%" flex_grow="1" style_pad_left="#space_lg" style_pad_right="#space_lg" style_pad_top="#space_lg"
            style_pad_bottom="#space_lg" flex_flow="column" style_pad_gap="#space_lg" scrollable="false">
      <!-- ================================================================== -->
      <!-- STATE: IDLE - Heater selection and target temperature -->
      <!-- ================================================================== -->
      <lv_obj name="state_idle"
              width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="start"
              style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
        <bind_flag_if_not_eq subject="pid_cal_state" flag="hidden" ref_value="0"/>
        <!-- Scrollable content -->
        <lv_obj name="idle_scroll"
                width="100%" flex_grow="1" style_pad_all="0" flex_flow="column"
                style_pad_gap="#space_sm" scrollable="true">
          <!-- Description -->
          <text_small width="100%"
                      text="Optimizes temperature control for stable, consistent heating."
                      translation_tag="Optimizes temperature control for stable, consistent heating."
                      style_text_color="#text_muted" style_text_align="center"/>
          <!-- Heater Selection (inline row) -->
          <lv_obj width="100%"
                  height="content" style_bg_color="#section_bg_color" style_radius="#border_radius"
                  style_pad_all="#space_sm" flex_flow="row" style_pad_gap="#space_md"
                  style_flex_cross_place="center" scrollable="false">
            <text_body text="Heater" translation_tag="Heater"/>
            <ui_button name="btn_heater_extruder" flex_grow="1" text="Extruder" translation_tag="Extruder">
              <bind_style name="pid_heater_selected" subject="pid_heater_is_extruder" ref_value="1"/>
              <bind_style name="pid_heater_unselected" subject="pid_heater_is_extruder" ref_value="0"/>
              <event_cb trigger="clicked" callback="on_pid_heater_extruder"/>
            </ui_button>
            <ui_button name="btn_heater_bed" flex_grow="1" text="Heated Bed" translation_tag="Heated Bed">
              <bind_style name="pid_heater_selected" subject="pid_heater_is_extruder" ref_value="0"/>
              <bind_style name="pid_heater_unselected" subject="pid_heater_is_extruder" ref_value="1"/>
              <event_cb trigger="clicked" callback="on_pid_heater_bed"/>
            </ui_button>
          </lv_obj>
          <!-- Two-column row: Temperature (left) + Fan slider (right) -->
          <lv_obj width="100%" height="content" style_pad_all="0" flex_flow="row"
                  style_pad_gap="#space_md" scrollable="false">
            <!-- Left column: Target Temperature -->
            <lv_obj flex_grow="1"
                    height="content" style_bg_color="#section_bg_color" style_radius="#border_radius"
                    style_pad_all="#space_md" flex_flow="column" style_pad_gap="#space_sm">
              <text_body text="Target Temperature" translation_tag="Target Temperature"/>
              <text_small width="100%" text="Tune at the temperature you print most often."
                          translation_tag="Tune at the temperature you print most often."
                          style_text_color="#text_muted"/>
              <!-- Material Presets (Extruder) - row 1 -->
              <lv_obj name="extruder_presets" width="100%" height="content" style_pad_all="0"
                      flex_flow="row" style_pad_gap="#space_xs" style_flex_main_place="start" scrollable="false">
                <bind_flag_if_eq subject="pid_heater_is_extruder" flag="hidden" ref_value="0"/>
                <ui_button name="btn_preset_pla" width="56" height="32" text="PLA" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_pla"/>
                </ui_button>
                <ui_button name="btn_preset_petg" width="56" height="32" text="PETG" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_petg"/>
                </ui_button>
                <ui_button name="btn_preset_abs" width="56" height="32" text="ABS" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_abs"/>
                </ui_button>
              </lv_obj>
              <!-- Material Presets (Extruder) - row 2 -->
              <lv_obj name="extruder_presets_2" width="100%" height="content" style_pad_all="0"
                      flex_flow="row" style_pad_gap="#space_xs" style_flex_main_place="start" scrollable="false">
                <bind_flag_if_eq subject="pid_heater_is_extruder" flag="hidden" ref_value="0"/>
                <ui_button name="btn_preset_pa" width="56" height="32" text="PA" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_pa"/>
                </ui_button>
                <ui_button name="btn_preset_tpu" width="56" height="32" text="TPU" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_tpu"/>
                </ui_button>
              </lv_obj>
              <!-- Material Presets (Bed) -->
              <lv_obj name="bed_presets" width="100%" height="content" style_pad_all="0"
                      flex_flow="row" style_pad_gap="#space_xs" style_flex_main_place="start" scrollable="false">
                <bind_flag_if_not_eq subject="pid_heater_is_extruder" flag="hidden" ref_value="0"/>
                <ui_button name="btn_preset_bed_pla" width="56" height="32" text="PLA" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_bed_pla"/>
                </ui_button>
                <ui_button name="btn_preset_bed_petg" width="56" height="32" text="PETG" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_bed_petg"/>
                </ui_button>
                <ui_button name="btn_preset_bed_abs" width="56" height="32" text="ABS" style_text_font="#font_small">
                  <event_cb trigger="clicked" callback="on_pid_preset_bed_abs"/>
                </ui_button>
              </lv_obj>
              <!-- Temperature: [-] 200°C [+] -->
              <lv_obj width="100%"
                      height="48" style_pad_all="0" flex_flow="row" style_flex_main_place="center"
                      style_flex_cross_place="center" style_pad_gap="#space_md" scrollable="false">
                <ui_button name="btn_temp_down" width="48" height="48" text="-" translation_tag="-">
                  <event_cb trigger="clicked" callback="on_pid_temp_down"/>
                </ui_button>
                <lv_label name="temp_display" flex_grow="1" text="200°C" translation_tag="200°C"
                          style_text_font="#font_heading" style_text_align="center" bind_text="pid_temp_display"/>
                <ui_button name="btn_temp_up" width="48" height="48" text="+" translation_tag="+">
                  <event_cb trigger="clicked" callback="on_pid_temp_up"/>
                </ui_button>
              </lv_obj>
              <text_small name="temp_hint"
                          width="100%" text="Select a material or adjust temperature" translation_tag="Select a material or adjust temperature" style_text_color="#text_muted"
                          style_text_align="center" bind_text="pid_temp_hint"/>
            </lv_obj>
            <!-- Vertical divider -->
            <divider_vertical/>
            <!-- Right column: Fan + Warning (always visible) -->
            <lv_obj flex_grow="1" height="content" style_pad_all="0"
                    flex_flow="column" style_pad_gap="#space_sm">
              <!-- Part Cooling Fan (extruder only) -->
              <lv_obj name="fan_speed_section" width="100%"
                      height="content" style_bg_color="#section_bg_color" style_radius="#border_radius"
                      style_pad_all="#space_md" flex_flow="column" style_pad_gap="#space_sm"
                      style_flex_main_place="center">
                <bind_flag_if_eq subject="pid_heater_is_extruder" flag="hidden" ref_value="0"/>
                <text_body text="Part Cooling Fan" translation_tag="Part Cooling Fan"/>
                <lv_obj width="100%" height="content" style_pad_top="#space_md" style_pad_bottom="#space_md"
                        style_pad_left="#space_lg" style_pad_right="#space_md" flex_flow="row"
                        style_flex_cross_place="center" style_pad_gap="#space_md" scrollable="false">
                  <lv_slider name="fan_speed_slider" flex_grow="1" min_value="0" max_value="100" value="0"/>
                  <lv_label name="fan_speed_label" text="0%" style_text_font="#font_small" width="40" style_text_align="right"/>
                </lv_obj>
                <text_small text="Match your typical print fan speed" translation_tag="Match your typical print fan speed" style_text_color="#text_muted"/>
              </lv_obj>
              <!-- Warning (always visible) -->
              <lv_obj width="100%" height="content" style_pad_all="0" flex_flow="row"
                      style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
                <icon src="alert" size="sm" variant="warning"/>
                <text_small text="Takes 3-5 min. Do not interrupt." translation_tag="Takes 3-5 min. Do not interrupt."
                            style_text_color="#text_muted" flex_grow="1"/>
              </lv_obj>
            </lv_obj>
          </lv_obj>
        </lv_obj>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- STATE: CALIBRATING - Progress display -->
      <!-- ================================================================== -->
      <lv_obj name="state_calibrating"
              width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="center"
              style_flex_cross_place="center" style_pad_gap="#space_lg" scrollable="false">
        <bind_flag_if_not_eq subject="pid_cal_state" flag="hidden" ref_value="1"/>
        <spinner size="lg"/>
        <text_heading text="Calibrating..." translation_tag="Calibrating..." style_text_align="center"/>
        <text_muted name="calibrating_heater" text="Extruder PID Tuning" translation_tag="Extruder PID Tuning" bind_text="pid_calibrating_heater"/>
        <!-- Temperature Display -->
        <lv_obj width="80%"
                height="content" style_bg_color="#section_bg_color" style_radius="#border_radius"
                style_pad_all="#space_lg" flex_flow="column" style_flex_cross_place="center" style_pad_gap="#space_xs">
          <text_small text="Current Temperature" translation_tag="Current Temperature"/>
          <lv_label name="current_temp_display"
                    text="25°C / 200°C" translation_tag="25°C / 200°C" style_text_font="#font_heading" bind_text="pid_current_temp"/>
        </lv_obj>
        <text_small width="80%" text="The heater will cycle on and off several times." translation_tag="The heater will cycle on and off several times." style_text_align="center"/>
        <!-- Abort Button -->
        <ui_button name="btn_abort" width="120" text="Abort" translation_tag="Abort" variant="danger">
          <event_cb trigger="clicked" callback="on_pid_abort"/>
        </ui_button>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- STATE: SAVING - Saving configuration -->
      <!-- ================================================================== -->
      <lv_obj name="state_saving"
              width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="center"
              style_flex_cross_place="center" style_pad_gap="#space_lg" scrollable="false">
        <bind_flag_if_not_eq subject="pid_cal_state" flag="hidden" ref_value="2"/>
        <spinner size="lg"/>
        <text_heading text="Saving Configuration..." translation_tag="Saving Configuration..." style_text_align="center"/>
        <text_small width="80%" text="Klipper will restart to apply new PID values." translation_tag="Klipper will restart to apply new PID values." style_text_align="center"/>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- STATE: COMPLETE - Results display -->
      <!-- ================================================================== -->
      <lv_obj name="state_complete"
              width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="center"
              style_flex_cross_place="center" style_pad_gap="#space_lg" scrollable="false">
        <bind_flag_if_not_eq subject="pid_cal_state" flag="hidden" ref_value="3"/>
        <icon src="check_circle" size="lg" variant="success"/>
        <text_heading text="Calibration Complete!" translation_tag="Calibration Complete!" style_text_align="center"/>
        <!-- PID Values Display -->
        <lv_obj width="80%"
                height="content" style_bg_color="#section_bg_color" style_radius="#border_radius"
                style_pad_all="#space_lg" flex_flow="column" style_pad_gap="#space_xs">
          <text_body width="100%" text="New PID Values" translation_tag="New PID Values" style_text_align="center"/>
          <lv_obj width="100%"
                  height="content" style_pad_all="0" flex_flow="row" style_flex_main_place="space_between"
                  scrollable="false">
            <text_body text="Kp:" translation_tag="Kp:"/>
            <text_muted name="pid_kp" text="0.000" bind_text="pid_kp"/>
          </lv_obj>
          <lv_obj width="100%"
                  height="content" style_pad_all="0" flex_flow="row" style_flex_main_place="space_between"
                  scrollable="false">
            <text_body text="Ki:" translation_tag="Ki:"/>
            <text_muted name="pid_ki" text="0.000" bind_text="pid_ki"/>
          </lv_obj>
          <lv_obj width="100%"
                  height="content" style_pad_all="0" flex_flow="row" style_flex_main_place="space_between"
                  scrollable="false">
            <text_body text="Kd:" translation_tag="Kd:"/>
            <text_muted name="pid_kd" text="0.000" bind_text="pid_kd"/>
          </lv_obj>
        </lv_obj>
        <text_small width="80%" text="Values have been saved to printer configuration." translation_tag="Values have been saved to printer configuration." style_text_align="center"/>
        <ui_button name="btn_done" width="140" height="56" text="Done" translation_tag="Done">
          <event_cb trigger="clicked" callback="on_pid_done"/>
        </ui_button>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- STATE: ERROR - Something went wrong -->
      <!-- ================================================================== -->
      <lv_obj name="state_error"
              width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="center"
              style_flex_cross_place="center" style_pad_gap="#space_lg" scrollable="false">
        <bind_flag_if_not_eq subject="pid_cal_state" flag="hidden" ref_value="4"/>
        <icon src="close_circle" size="lg" variant="danger"/>
        <text_heading text="Calibration Failed" translation_tag="Calibration Failed" style_text_align="center"/>
        <text_muted name="error_message"
                    width="80%" text="An error occurred during calibration." translation_tag="An error occurred during calibration." style_text_align="center" long_mode="wrap"
                    bind_text="pid_error_message"/>
        <lv_obj width="100%"
                height="56" style_pad_all="0" flex_flow="row" style_flex_main_place="center" style_pad_gap="#space_md"
                scrollable="false">
          <ui_button name="btn_close_error" width="140" height="56" text="Close" translation_tag="Close">
            <event_cb trigger="clicked" callback="on_pid_done"/>
          </ui_button>
          <ui_button name="btn_retry" width="140" height="56" text="Retry" translation_tag="Retry" variant="primary">
            <event_cb trigger="clicked" callback="on_pid_retry"/>
          </ui_button>
        </lv_obj>
      </lv_obj>
    </lv_obj>
  </view>
</component>
