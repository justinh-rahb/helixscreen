# SPDX-License-Identifier: GPL-3.0-or-later
#
# HelixScreen - Creality K1 Series (MIPS32) DYNAMIC Linking Cross-Compilation Toolchain
#
# Build: docker build -t helixscreen/toolchain-k1-dynamic -f Dockerfile.k1-dynamic .
# Usage: docker run --rm -v $(pwd):/src -w /src helixscreen/toolchain-k1-dynamic make PLATFORM_TARGET=k1-dynamic -j$(nproc)
#
# Target: Creality K1C, K1 Max, K2 Plus (and other Ingenic X2000E devices)
#   - CPU: Ingenic X2000E, MIPS32r2 dual-core @ 1.2 GHz
#   - Display: 480x400 (K1), 480x800 (K2)
#   - RAM: 256MB
#   - C Library: glibc 2.29 (DYNAMIC linking against K1 firmware libraries)
#
# Strategy: Build a custom crosstool-NG toolchain with NaN2008 + FP64 ABI support,
# then dynamically link against the K1's native glibc 2.29 system libraries.
#
# Unlike Dockerfile.k1 (which uses Bootlin's musl toolchain with static linking),
# this produces a dynamically linked binary that uses the K1's existing shared
# libraries. This is required for features that depend on system library integration.
#
# Why crosstool-NG: No off-the-shelf MIPS32 toolchain ships with NaN2008 support,
# which is required for ABI compatibility with the K1 firmware. crosstool-NG lets
# us build gcc with -mnan=2008 -mfp64 as default flags.
#
# K1 sysroot libraries are extracted from K1 Max firmware.

# ==============================================================================
# Stage 1: Build crosstool-NG toolchain from source
# ==============================================================================

FROM debian:bookworm AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install crosstool-NG build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    autoconf \
    automake \
    libtool \
    libtool-bin \
    flex \
    bison \
    gawk \
    texinfo \
    help2man \
    libncurses-dev \
    python3 \
    unzip \
    rsync \
    wget \
    git \
    gcc \
    g++ \
    make \
    patch \
    xz-utils \
    bzip2 \
    file \
    gperf \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Clone and build crosstool-NG 1.26.0
WORKDIR /tmp/ct-ng-src
RUN git clone --depth 1 --branch crosstool-ng-1.26.0 \
    https://github.com/crosstool-ng/crosstool-ng.git . && \
    ./bootstrap && \
    ./configure --prefix=/tmp/ct-ng-install && \
    make -j$(nproc) && \
    make install

ENV PATH="/tmp/ct-ng-install/bin:$PATH"

# crosstool-NG refuses to build as root â€” create a build user
RUN useradd -m builder && \
    mkdir -p /opt/k1-toolchain /tmp/ct-ng-build && \
    chown -R builder:builder /opt/k1-toolchain /tmp/ct-ng-build

# Build the K1 toolchain using our defconfig
USER builder
WORKDIR /tmp/ct-ng-build
COPY --chown=builder:builder k1-ct-ng.config .config
RUN ct-ng olddefconfig && \
    ct-ng build

# Switch back to root for remaining stages
USER root

# Toolchain is now at /opt/k1-toolchain

# ==============================================================================
# Stage 2: Runtime image with toolchain and sysroot
# ==============================================================================

FROM debian:bookworm-slim

LABEL maintainer="HelixScreen <dev@helixscreen.io>"
LABEL description="Cross-compilation toolchain for Creality K1 series (MIPS32 dynamic, glibc 2.29)"

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
# Note: autotools required for building libnl submodule
# NOTE: nlohmann-json is bundled with libhv (lib/libhv/cpputil/json.hpp)
# DO NOT install nlohmann-json3-dev - it causes ABI mismatches
# Always use: #include "hv/json.hpp" (NOT <nlohmann/json.hpp>)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    pkg-config \
    ca-certificates \
    make \
    cmake \
    python3 \
    python3-yaml \
    file \
    wget \
    xz-utils \
    bzip2 \
    autoconf \
    automake \
    libtool \
    flex \
    bison \
    && rm -rf /var/lib/apt/lists/*

# Copy the crosstool-NG built toolchain from stage 1
COPY --from=builder /opt/k1-toolchain /opt/k1-toolchain

# Copy K1 sysroot libraries (from K1 Max firmware) into the toolchain sysroot
# These provide glibc 2.29 shared libraries for dynamic linking
COPY k1-sysroot/lib/ /opt/k1-toolchain/mipsel-k1-linux-gnu/sysroot/lib/

# ==============================================================================
# zlib 1.3.1 - Cross-Compiled Library
# ==============================================================================
# Required for debug bundle gzip compression (debug_bundle_collector.cpp).
# The crosstool-NG toolchain doesn't include zlib, so we build it from source.
WORKDIR /tmp
RUN export PATH="/opt/k1-toolchain/bin:$PATH" && \
    wget -q https://zlib.net/zlib-1.3.1.tar.gz && \
    tar xzf zlib-1.3.1.tar.gz && \
    cd zlib-1.3.1 && \
    CHOST=mipsel-k1-linux-gnu ./configure \
        --prefix=/opt/k1-toolchain/mipsel-k1-linux-gnu/sysroot/usr && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf zlib-1.3.1 zlib-1.3.1.tar.gz

# ==============================================================================
# Cross-Compilation Environment
# ==============================================================================

ENV PATH="/opt/k1-toolchain/bin:$PATH"
ENV CROSS_COMPILE=mipsel-k1-linux-gnu-
ENV CC=mipsel-k1-linux-gnu-gcc
ENV CXX=mipsel-k1-linux-gnu-g++
# Use plain ar/ranlib (GCC 7.5 static toolchain doesn't ship liblto_plugin.so)
ENV AR=mipsel-k1-linux-gnu-ar
ENV STRIP=mipsel-k1-linux-gnu-strip
ENV RANLIB=mipsel-k1-linux-gnu-ranlib
ENV LD=mipsel-k1-linux-gnu-ld

# Target-specific flags for MIPS32r2 (Ingenic X2000E)
# NaN2008 + FP64 required for ABI compatibility with K1 firmware
ENV TARGET_CFLAGS="-march=mips32r2 -mtune=mips32r2 -mnan=2008 -mfp64"
ENV TARGET_LDFLAGS=""

# Working directory
WORKDIR /src

# Configure git to trust the mounted source directory
# Required because the container runs as root but files are owned by the host user
RUN git config --global --add safe.directory '*'

# Verify the toolchain works
RUN mipsel-k1-linux-gnu-gcc --version && \
    mipsel-k1-linux-gnu-g++ --version && \
    mipsel-k1-linux-gnu-ar --version && \
    mipsel-k1-linux-gnu-ranlib --version && \
    echo "Toolchain verification passed" && \
    echo "" && \
    echo "NOTE: This toolchain uses glibc 2.29 with DYNAMIC linking" && \
    echo "against K1 firmware libraries (NaN2008 + FP64 ABI)."

# Default command: build for K1 (dynamic)
# SKIP_OPTIONAL_DEPS=1 runs minimal dependency check (skips npm, clang-format, etc.)
CMD ["make", "PLATFORM_TARGET=k1-dynamic", "SKIP_OPTIONAL_DEPS=1", "-j"]
